version: '3.8'

services:
  tvlist-mm:
    # 镜像名称和标签
    image: tvlist-mm:latest

    # 容器名称
    container_name: tvlist-mm

    # 构建配置
    build:
      context: .
      dockerfile: Dockerfile

    # 端口映射（容器:主机）
    ports:
      - "3000:3000"

    # 环境变量（从 .env 文件读取）
    environment:
      # 管理员密码
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}

      # HTTPS 配置
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}

      # 数据库配置
      - DATABASE_PATH=${DATABASE_PATH:-/data/tvlist.db}

      # TV.TXT 访问保护
      - TV_TXT_ACCESS_KEY=${TV_TXT_ACCESS_KEY}
      - TV_TXT_SECONDARY_KEYS=${TV_TXT_SECONDARY_KEYS}
      - TV_TXT_RATE_LIMIT=${TV_TXT_RATE_LIMIT:-60}

      # Node.js 配置
      - NODE_ENV=production
      - PORT=3000

      # 日志级别：debug | info | warn | error | none
      # 生产环境建议使用 warn 或 error 以减少日志量
      - LOG_LEVEL=${LOG_LEVEL:-warn}

    # 数据卷挂载（持久化 SQLite 数据库）
    volumes:
      - tvlist-data:/data

    # 重启策略：除非手动停止，否则总是自动重启
    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/auth/verify', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 401 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # 日志配置：限制日志文件大小，防止磁盘占满
    logging:
      driver: "json-file"
      options:
        max-size: "5m"      # 单个日志文件最大 5MB
        max-file: "3"       # 最多保留 3 个日志文件（总共最大 15MB）
        compress: "true"    # 压缩旧日志文件

    # 网络模式
    networks:
      - tvlist-network

# 自定义网络
networks:
  tvlist-network:
    driver: bridge

# 数据卷定义（用于持久化 SQLite 数据库）
volumes:
  tvlist-data:
    driver: local
